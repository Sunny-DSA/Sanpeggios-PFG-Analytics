<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sanpeggio's PFG Analytics V3 - Complete Platform</title>
    
    <!-- Chart.js and dependencies -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@2.0.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.29.3/index.min.js"></script>
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Scripts -->
    <script src="js/tab-navigation.js" defer></script>
    <script src="js/parser.js" defer></script>
    <script src="js/database.js" defer></script>
    <script src="js/store-manager.js" defer></script>
    <script src="js/store-ui.js" defer></script>
    <script src="js/product-analytics.js" defer></script>
    <script src="js/product-charts-fixed.js" defer></script>
    <script src="js/chart-init.js" defer></script>
</head>
<body>
    <div class="container">
        <!-- Mobile Toggle Button -->
        <button class="sidebar-toggle" onclick="toggleSidebar()">‚ò∞</button>
        
        <!-- Sidebar Navigation -->
        <nav class="sidebar-nav" id="sidebarNav">
            <div class="sidebar-header">
                <h2>üçï PFG Analytics V3</h2>
            </div>
            <div class="sidebar-tabs">
                <button class="sidebar-tab active" onclick="showTab('overview')" data-tab="overview">
                    <span class="sidebar-tab-icon">üìä</span>
                    <span>Overview</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('price-analytics')" data-tab="price-analytics">
                    <span class="sidebar-tab-icon">üìà</span>
                    <span>Price Analytics</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('supply-chain')" data-tab="supply-chain">
                    <span class="sidebar-tab-icon">üè≠</span>
                    <span>Supply Chain</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('category-insights')" data-tab="category-insights">
                    <span class="sidebar-tab-icon">üìä</span>
                    <span>Category Insights</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('product-intelligence')" data-tab="product-intelligence">
                    <span class="sidebar-tab-icon">üì¶</span>
                    <span>Product Intelligence</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('brand-analysis')" data-tab="brand-analysis">
                    <span class="sidebar-tab-icon">üè∑Ô∏è</span>
                    <span>Brand Analysis</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('optimization')" data-tab="optimization">
                    <span class="sidebar-tab-icon">üí°</span>
                    <span>Cost Optimization</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('settings')" data-tab="settings">
                    <span class="sidebar-tab-icon">‚öôÔ∏è</span>
                    <span>Settings & Alerts</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('export')" data-tab="export">
                    <span class="sidebar-tab-icon">üì§</span>
                    <span>Export & Reports</span>
                </button>
                <button class="sidebar-tab" onclick="showTab('data-management')" data-tab="data-management">
                    <span class="sidebar-tab-icon">üìÅ</span>
                    <span>Data Management</span>
                </button>
            </div>
        </nav>
        
        <!-- Overlay for mobile -->
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        
        <!-- Main Content Area -->
        <div class="main-content">
            <!-- Header -->
            <header>
                <h1>üçï Sanpeggio's PFG Analytics V3</h1>
                <p class="subtitle">Advanced Supply Chain Intelligence & Cost Optimization Platform</p>
            </header>

            <!-- Store Navigation Tabs -->
            <nav class="nav-tabs">
                <button class="nav-tab active" data-store="all">All Stores</button>
                <button class="nav-tab" data-store="280">280 Store</button>
                <button class="nav-tab" data-store="chelsea">Chelsea Store</button>
                <button class="nav-tab" data-store="valleydale">Valleydale Store</button>
                <button class="nav-tab" data-store="homewood">Homewood Store</button>
                <button class="nav-tab" data-store="trussville">Trussville Store</button>
                <button class="nav-tab" data-store="5points">5 Points Store</button>
            </nav>

            <!-- Alert Container -->
            <div id="alertContainer" class="alert-container"></div>

            <!-- Tab Content: Overview -->
            <div id="overview" class="tab-content active">
                <!-- Summary Statistics -->
                <section class="section">
                    <h2>üìä Dashboard Overview</h2>
                    <div class="stats-grid">
                        <div class="stat-card primary">
                            <div class="value" id="totalSpend">$0</div>
                            <div class="label">Total Spend</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="totalRecords">0</div>
                            <div class="label">Invoice Records</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="uniqueCategories">0</div>
                            <div class="label">Categories</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="uniqueVendors">0</div>
                            <div class="label">Vendors</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="spikeCount">0</div>
                            <div class="label">Price Spikes</div>
                        </div>
                        <div class="stat-card">
                            <div class="value" id="dateRange">-</div>
                            <div class="label">Date Range</div>
                        </div>
                    </div>
                </section>

                <!-- Controls Section -->
                <section class="controls-section">
                    <h3>üéõÔ∏è Analysis Controls</h3>
                    <div class="control-group">
                        <label>
                            Volatility Window:
                            <select id="volWindow">
                                <option value="7">7 days</option>
                                <option value="14">14 days</option>
                                <option value="30" selected>30 days</option>
                                <option value="60">60 days</option>
                                <option value="90">90 days</option>
                            </select>
                        </label>
                        
                        <label>
                            Category Filter:
                            <select id="categoryFilter">
                                <option value="all">All Categories</option>
                            </select>
                        </label>
                        
                        <label>
                            Start Date:
                            <input type="month" id="startDate" min="2020-01" max="2025-12">
                        </label>
                        
                        <label>
                            End Date:
                            <input type="month" id="endDate" min="2020-01" max="2025-12">
                        </label>
                        
                        <button class="btn btn-primary" onclick="refreshAnalytics()">
                            üîÑ Update Analysis
                        </button>
                    </div>
                </section>
            </div>

            <!-- Tab Content: Price Analytics -->
            <div id="price-analytics" class="tab-content">
                <div class="grid grid-2">
                    <!-- Price Trend Chart with Spikes -->
                    <section class="section">
                        <h2>üìà Price Trends & Spike Detection</h2>
                        <div class="chart-container">
                            <canvas id="priceTrendChart"></canvas>
                        </div>
                        <div id="priceTrendSummary" class="mt-2"></div>
                        <p class="text-small text-muted">
                            Weekly price trends with 4-week moving averages when sufficient data is available. 
                            Red/Green markers indicate price spikes above/below normal range.
                            Click on data points to drill down into invoice details.
                        </p>
                    </section>

                    <!-- Volatility Analysis -->
                    <section class="section">
                        <h2>üìä Price Volatility Analysis</h2>
                        <div class="chart-container">
                            <canvas id="volatilityChart"></canvas>
                        </div>
                        <p class="text-small text-muted">
                            Coefficient of Variation (%) shows price stability. Higher values indicate more volatile pricing.
                        </p>
                    </section>
                </div>

                <!-- Budget Variance -->
                <section class="section">
                    <h2>üí∞ Budget Variance Report</h2>
                    <div class="chart-container small">
                        <canvas id="budgetVarianceChart"></canvas>
                    </div>
                    <div id="budgetTable" class="mt-2"></div>
                </section>
            </div>

            <!-- Tab Content: Supply Chain -->
            <div id="supply-chain" class="tab-content">
                <div class="grid grid-2">
                    <!-- Supply Concentration -->
                    <section class="section">
                        <h2>üè≠ Vendor Concentration Analysis</h2>
                        <div class="chart-container">
                            <canvas id="concentrationChart"></canvas>
                        </div>
                        <div id="concentrationMetrics" class="mt-2"></div>
                    </section>

                    <!-- Spend Forecast -->
                    <section class="section">
                        <h2>üîÆ Spend Forecast</h2>
                        <div class="chart-container">
                            <canvas id="forecastChart"></canvas>
                        </div>
                        <p class="text-small text-muted">
                            3-month forecast based on historical trends. Dashed line indicates projected values.
                        </p>
                    </section>
                </div>
            </div>

            <!-- Tab Content: Category Insights -->
            <div id="category-insights" class="tab-content">
                <!-- Category Spending Trends -->
                <section class="section">
                    <h2>üìä Category Spending Trends</h2>
                    <div class="chart-container large">
                        <canvas id="categoryHeatmap"></canvas>
                    </div>
                    <p class="text-small text-muted">
                        Monthly spending trends by category. Shows spending patterns and helps identify budget allocation opportunities.
                    </p>
                </section>
            </div>

            <!-- Tab Content: Product Intelligence -->
            <div id="product-intelligence" class="tab-content">
                <section class="section">
                    <h2>üì¶ Product Analytics Dashboard</h2>
                    
                    <!-- Data Quality Indicators -->
                    <div id="dataQualityIndicators" class="mb-3"></div>
                    
                    <!-- Product Search -->
                    <div class="control-group mb-3">
                        <label style="flex: 1; position: relative;">
                            Product Search:
                            <input type="text" id="productSearch" placeholder="Search for products..." style="width: 100%;">
                            <div id="searchResults" class="search-results"></div>
                        </label>
                    </div>
                    
                    <!-- ABC Analysis -->
                    <div class="grid grid-2 mb-3">
                        <div>
                            <h3>üìä ABC Analysis - Pareto Chart</h3>
                            <div class="chart-container">
                                <canvas id="abcChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Product Lifecycle -->
                        <div>
                            <h3>üîÑ Product Lifecycle Distribution</h3>
                            <div class="chart-container">
                                <canvas id="lifecycleChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pack Size Optimization and Vendor Diversification -->
                    <div class="grid grid-2 mb-3">
                        <div>
                            <h3>üì¶ Pack Size Optimization</h3>
                            <div class="chart-container">
                                <canvas id="packSizeChart"></canvas>
                            </div>
                            <p class="text-small text-muted">
                                Cost per unit across different pack sizes. Lower bars indicate better value.
                            </p>
                        </div>
                        
                        <div>
                            <h3>üè≠ Vendor Diversification by Category</h3>
                            <div class="chart-container">
                                <canvas id="vendorDiversificationChart"></canvas>
                            </div>
                            <p class="text-small text-muted">
                                Higher scores indicate better vendor diversification (less risk).
                            </p>
                        </div>
                    </div>
                    
                    <!-- Top Products Table with Filters -->
                    <div class="mb-3">
                        <h3>üèÜ Top Products by Spend</h3>
                        <div class="control-group mb-2">
                            <label>
                                Filter by Category:
                                <select id="productCategoryFilter">
                                    <option value="all">All Categories</option>
                                </select>
                            </label>
                            <label>
                                Filter by Brand:
                                <select id="productBrandFilter">
                                    <option value="all">All Brands</option>
                                </select>
                            </label>
                            <label>
                                Filter by ABC:
                                <select id="productABCFilter">
                                    <option value="all">All Classifications</option>
                                    <option value="A">A Items (Top 80%)</option>
                                    <option value="B">B Items (80-95%)</option>
                                    <option value="C">C Items (95-100%)</option>
                                </select>
                            </label>
                            <button class="btn btn-secondary btn-small" onclick="resetProductFilters()">Reset Filters</button>
                        </div>
                        <div id="topProductsTable"></div>
                    </div>
                </section>
            </div>

            <!-- Tab Content: Brand Analysis -->
            <div id="brand-analysis" class="tab-content">
                <section class="section">
                    <h2>üè∑Ô∏è Brand Performance Analysis</h2>
                    
                    <div class="grid grid-2 mb-3">
                        <!-- Brand Performance Bubble Chart -->
                        <div>
                            <h3>üí∞ Brand Value Analysis</h3>
                            <div class="chart-container">
                                <canvas id="brandChart"></canvas>
                            </div>
                            <p class="text-small text-muted">
                                Each brand has a unique color. Bubble size represents product variety. Click bubbles for details.
                            </p>
                        </div>
                        
                        <!-- Brand Comparison Radar -->
                        <div>
                            <h3>üìä Brand Comparison</h3>
                            <div class="chart-container">
                                <canvas id="brandComparisonChart"></canvas>
                            </div>
                            <p class="text-small text-muted">
                                Multi-dimensional brand comparison. Click to view brand details.
                            </p>
                        </div>
                    </div>
                    
                    <div class="grid grid-2 mb-3">
                        <!-- Brand Market Share -->
                        <div>
                            <h3>üìä Brand Market Share</h3>
                            <div class="chart-container small">
                                <canvas id="brandMarketShareChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Brand Summary Table -->
                        <div>
                            <h3>üìã Brand Performance Summary</h3>
                            <div id="brandSummaryTable" style="max-height: 300px; overflow-y: auto;"></div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Tab Content: Cost Optimization -->
            <div id="optimization" class="tab-content">
                <section class="section">
                    <h2>üí° Cost Optimization Opportunities</h2>
                    
                    <div class="mb-3">
                        <h3>üîÑ Product Substitution Recommendations</h3>
                        <div id="substitutionTable"></div>
                    </div>
                    
                    <div class="alert alert-info">
                        <strong>üí∞ Total Potential Savings:</strong> 
                        <span id="totalPotentialSavings">Calculating...</span> annually through strategic substitutions
                    </div>
                </section>
            </div>

            <!-- Tab Content: Settings -->
            <div id="settings" class="tab-content">
                <section class="section">
                    <h2>‚öôÔ∏è Alert Configuration & Settings</h2>
                    <div class="settings-panel">
                        <div class="settings-group">
                            <h4>Alert Thresholds</h4>
                            <div class="settings-row">
                                <label>Price Spike Z-Score Threshold:</label>
                                <input type="number" id="threshZ" value="2" min="1" max="5" step="0.5">
                            </div>
                            <div class="settings-row">
                                <label>Budget Variance % Threshold:</label>
                                <input type="number" id="threshVar" value="10" min="5" max="50" step="5">
                            </div>
                            <div class="settings-row">
                                <label>Vendor Concentration % Threshold:</label>
                                <input type="number" id="threshConc" value="40" min="20" max="80" step="5">
                            </div>
                        </div>
                        
                        <div class="settings-group">
                            <h4>Email Notifications</h4>
                            <div class="settings-row">
                                <label>Enable Email Alerts:</label>
                                <input type="checkbox" id="emailEnabled">
                            </div>
                            <div class="settings-row">
                                <label>Recipients (comma-separated):</label>
                                <input type="email" id="emailRecipients" placeholder="owner@sanpeggios.com, manager@sanpeggios.com" style="width: 400px;">
                            </div>
                        </div>
                        
                        <div class="btn-group">
                            <button class="btn btn-success" id="saveSettings">üíæ Save Settings</button>
                            <button class="btn btn-secondary" onclick="AlertConfig.load()">üîÑ Reset to Defaults</button>
                        </div>
                    </div>
                </section>
            </div>

            <!-- Tab Content: Export -->
            <div id="export" class="tab-content">
                <section class="section">
                    <h2>üì§ Export & Actions</h2>
                    <div class="btn-group">
                        <button class="btn btn-primary" id="exportCsv">
                            üìä Export to CSV
                        </button>
                        <button class="btn btn-primary" onclick="window.print()">
                            üñ®Ô∏è Print Report
                        </button>
                        <button class="btn btn-primary" onclick="generatePDFReport()">
                            üìÑ Generate PDF Report
                        </button>
                        <button class="btn btn-secondary" onclick="scheduleReport()">
                            üìÖ Schedule Reports
                        </button>
                    </div>
                </section>
            </div>

            <!-- Tab Content: Data Management -->
            <div id="data-management" class="tab-content">
                <section class="section">
                    <h2>üìÅ Data Management</h2>
                    <div class="upload-area">
                        <!-- Upload UI will be created by store-ui.js -->
                    </div>
                </section>
            </div>
        </div>
    </div>

    <!-- Drill-down Modal -->
    <div id="drillDownModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Invoice Details</h3>
                <button class="modal-close" onclick="this.closest('.modal').style.display='none'">√ó</button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Dynamic content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Product Details Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="productModalTitle">Product Details</h3>
                <button class="modal-close" onclick="this.closest('.modal').style.display='none'">√ó</button>
            </div>
            <div class="modal-body" id="productModalBody">
                <!-- Dynamic product details will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Additional Scripts for functionality -->
    <script>
        // PDF Report Generation (placeholder)
        function generatePDFReport() {
            alert('PDF generation would be implemented here. For now, use Print (Ctrl+P) and save as PDF.');
        }

        // Schedule Reports (placeholder)
        function scheduleReport() {
            alert('Report scheduling would open a dialog to configure automated reports.');
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }
    </script>
</body>
</html>